CREATE SCHEMA IF NOT EXISTS weather;

CREATE TABLE IF NOT EXISTS weather.locations (
       city_id INTEGER PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
       country_name VARCHAR NOT NULL,
       city_name VARCHAR NOT NULL,
       lat REAL NOT NULL,
       long REAL NOT NULL
);

CREATE TABLE IF NOT EXISTS weather.data (
       id INTEGER PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
       temperature_c REAL NOT NULL,
       city_id INTEGER CONSTRAINT weather_data_location_id_constr REFERENCES weather.locations (city_id)
);

INSERT INTO weather.locations
    (city_name, country_name, lat, long)
SELECT * FROM (
    VALUES
              ('Tirana','Albania',41.3275,19.8189),
              ('Vienna','Austria',48.2085,16.3721),
              ('Graz','Austria',47.0667,15.45),
              ('Floridsdorf','Austria',48.25,16.4),
              ('Hrodna','Belarus',53.6884,23.8258),
              ('Brest','Belarus',52.0975,23.6877),
              ('Minsk','Belarus',53.9,27.5667),
              ('Brussels','Belgium',50.8504,4.34878),
              ('Liege','Belgium',50.6337,5.56749),
              ('Charleroi','Belgium',50.4114,4.44448),
              ('Antwerpen','Belgium',51.2205,4.40026),
              ('Anderlecht','Belgium',50.8362,4.31454),
              ('Gent','Belgium',51.05,3.71667),
              ('Zenica','Bosnia and Herzegovina',44.2017,17.904),
              ('Banja Luka','Bosnia and Herzegovina',44.7784,17.1939),
              ('Sarajevo','Bosnia and Herzegovina',43.8486,18.3564),
              ('Plovdiv','Bulgaria',42.15,24.75),
              ('Burgas','Bulgaria',42.5061,27.4678),
              ('Varna','Bulgaria',43.2167,27.9167),
              ('Sofia','Bulgaria',42.6975,23.3242),
              ('Split','Croatia',43.5089,16.4391),
              ('Zagreb','Croatia',45.8144,15.978),
              ('Nicosia','Cyprus',35.1753,33.3642),
              ('Ostrava','Czech Republic',49.8346,18.282),
              ('Prague','Czech Republic',50.088,14.4208),
              ('Brno','Czech Republic',49.1952,16.608),
              ('Pilsen','Czech Republic',49.7475,13.3776),
              ('Arhus','Denmark',56.1567,10.2108),
              ('Copenhagen','Denmark',55.6759,12.5655),
              ('Tallinn','Estonia',59.437,24.7535),
              ('Helsinki','Finland',60.1695,24.9354),
              ('Turku','Finland',60.4515,22.2687),
              ('Tampere','Finland',61.4991,23.7871),
              ('Bordeaux','France',44.8404,-0.5805),
              ('Nantes','France',47.2173,-1.55336),
              ('Strasbourg','France',48.5839,7.74553),
              ('Lille','France',50.633,3.05858),
              ('Toulouse','France',43.6043,1.44367),
              ('Nice','France',43.7031,7.26608),
              ('Paris','France',48.8534,2.3488),
              ('Lyon','France',45.7485,4.84671),
              ('Marseille','France',43.297,5.38107),
              ('Montpellier','France',43.6109,3.87635),
              ('Bremen','Germany',53.0758,8.80717),
              ('Duesseldorf','Germany',51.2217,6.77616),
              ('Munich','Germany',48.1374,11.5755),
              ('Hamburg','Germany',53.5507,9.99302),
              ('Berlin','Germany',52.5244,13.4105),
              ('Koln','Germany',50.9333,6.95),
              ('Dortmund','Germany',51.5149,7.466),
              ('Stuttgart','Germany',48.7823,9.17702),
              ('Essen','Germany',51.4566,7.01228),
              ('Frankfurt am Main','Germany',50.1155,8.68417),
              ('Patra','Greece',38.2444,21.7344),
              ('Thessaloniki','Greece',40.6436,22.9309),
              ('Piraeus','Greece',37.942,23.6462),
              ('Athens','Greece',37.9838,23.7278),
              ('Szeged','Hungary',46.253,20.1482),
              ('Debrecen','Hungary',47.5317,21.6244),
              ('Budapest','Hungary',47.4983,19.0404),
              ('Cork','Ireland',51.898,-8.47061),
              ('Dublin','Ireland',53.3331,-6.24889),
              ('Genoa','Italy',44.4048,8.94439),
              ('Bologna','Italy',44.4938,11.3387),
              ('Palermo','Italy',38.132,13.3356),
              ('Bari','Italy',41.1207,16.8698),
              ('Florence','Italy',43.7793,11.2463),
              ('Rome','Italy',41.8919,12.5113),
              ('Milan','Italy',45.4643,9.18951),
              ('Turin','Italy',45.0705,7.68682),
              ('Catania','Italy',37.4922,15.0704),
              ('Naples','Italy',40.8522,14.2681),
              ('Pristina','Kosovo',42.6727,21.1669),
              ('Prizren','Kosovo',42.2139,20.7397),
              ('Riga','Latvia',56.946,24.1059),
              ('Kaunas','Lithuania',54.9027,23.9096),
              ('Klaipeda','Lithuania',55.7068,21.1391),
              ('Vilnius','Lithuania',54.6892,25.2798),
              ('Chisinau','Moldova',47.0056,28.8575),
              ('Tiraspol','Moldova',46.8427,29.6291),
              ('Podgorica','Montenegro',42.4411,19.2636),
              ('Utrecht','Netherlands',52.0908,5.12222),
              ('Tilburg','Netherlands',51.5555,5.0913),
              ('Almere Stad','Netherlands',52.3703,5.21413),
              ('Groningen','Netherlands',53.2192,6.56667),
              ('The Hague','Netherlands',52.0767,4.29861),
              ('Amsterdam','Netherlands',52.374,4.88969),
              ('Eindhoven','Netherlands',51.4408,5.47778),
              ('Rotterdam','Netherlands',51.9225,4.47917),
              ('Breda','Netherlands',51.5866,4.77596),
              ('Nijmegen','Netherlands',51.8425,5.85278),
              ('Skopje','North Macedonia',41.9965,21.4314),
              ('Bergen','Norway',60.393,5.32415),
              ('Oslo','Norway',59.9127,10.7461),
              ('Katowice','Poland',50.2584,19.0275),
              ('Poznan','Poland',52.4069,16.9299),
              ('Lodz','Poland',51.7706,19.4739),
              ('Krakow','Poland',50.0614,19.9366),
              ('Lublin','Poland',51.25,22.5667),
              ('Wroclaw','Poland',51.1,17.0333),
              ('Warsaw','Poland',52.2298,21.0118),
              ('Gdansk','Poland',54.3523,18.6491),
              ('Lisbon','Portugal',38.7167,-9.13333),
              ('Porto','Portugal',41.1496,-8.61099),
              ('Amadora','Portugal',38.7538,-9.23083),
              ('Galati','Romania',45.4369,28.0503),
              ('Craiova','Romania',44.3167,23.8),
              ('Iasi','Romania',47.1667,27.6),
              ('Cluj-Napoca','Romania',46.7667,23.6),
              ('Timisoara','Romania',45.7537,21.2257),
              ('Bucharest','Romania',44.4323,26.1063),
              ('Constanta','Romania',44.1807,28.6343),
              ('Yekaterinburg','Russia',56.8519,60.6122),
              ('Saint Petersburg','Russia',59.9386,30.3141),
              ('Samara','Russia',53.2001,50.15),
              ('Moscow','Russia',55.7522,37.6156),
              ('Novi Sad','Serbia',45.2517,19.8369),
              ('Belgrade','Serbia',44.804,20.4651),
              ('Nis','Serbia',43.3247,21.9033),
              ('Kosice','Slovakia',48.714,21.2581),
              ('Bratislava','Slovakia',48.1482,17.1067),
              ('Ljubljana','Slovenia',46.0511,14.5051),
              ('Las Palmas de Gran Canaria','Spain',28.0997,-15.4134),
              ('Valencia','Spain',39.4697,-0.37739),
              ('Bilbao','Spain',43.2627,-2.92528),
              ('Barcelona','Spain',41.3888,2.15899),
              ('Madrid','Spain',40.4165,-3.70256),
              ('Palma','Spain',39.5694,2.65024),
              ('Murcia','Spain',37.987,-1.13004),
              ('Zaragoza','Spain',41.6561,-0.87734),
              ('Malaga','Spain',36.7202,-4.42034),
              ('Sevilla','Spain',37.3828,-5.97317),
              ('Stockholm','Sweden',59.3294,18.0687),
              ('Malmoe','Sweden',55.6059,13.0007),
              ('Goeteborg','Sweden',57.7072,11.9668),
              ('Zurich','Switzerland',47.3667,8.55),
              ('Geneve','Switzerland',46.2022,6.14569),
              ('Basel','Switzerland',47.5584,7.57327),
              ('Donetsk','Ukraine',48.023,37.8022),
              ('Sevastopol','Ukraine',44.6079,33.5213),
              ('Kyiv','Ukraine',50.4547,30.5238),
              ('Lviv','Ukraine',49.8383,24.0232),
              ('Dnipro','Ukraine',48.4666,35.0407),
              ('Odessa','Ukraine',46.4857,30.7438),
              ('Cardiff','United Kingdom',51.48,-3.18),
              ('Leeds','United Kingdom',53.7965,-1.54785),
              ('London','United Kingdom',51.5085,-0.12574),
              ('Sheffield','United Kingdom',53.383,-1.4659),
              ('Bristol','United Kingdom',51.4552,-2.59665),
              ('Glasgow','United Kingdom',55.8652,-4.25763),
              ('Liverpool','United Kingdom',53.4106,-2.97794),
              ('Birmingham','United Kingdom',52.4814,-1.89983),
              ('Leicester','United Kingdom',52.6386,-1.13169),
              ('Edinburgh','United Kingdom',55.9521,-3.19648)
    ) a(country, city, lat, long)
WHERE
    NOT EXISTS (
        SELECT city_id FROM weather.locations WHERE city_id = 1
    );

CREATE OR REPLACE VIEW LatestWeatherData
AS
WITH latest_weather_data AS
(
    WITH sorted_weather_data AS
    (
        SELECT
            id, temperature_c, city_id,
            COUNT(id) OVER (PARTITION BY city_id) AS temp_id_count,
            ROW_NUMBER() OVER (PARTITION BY city_id ORDER BY id DESC) AS partition_sort_id
            FROM weather.data
    )
    SELECT city_id, temperature_c
    FROM sorted_weather_data
    WHERE partition_sort_id = 1
)
SELECT city_name, country_name, temperature_c
FROM weather.locations
JOIN latest_weather_data ON latest_weather_data.city_id = weather.locations.city_id
ORDER BY temperature_c DESC;
